sudo: false
language: generic

services:
  - docker

env:
  global:
    - BASENAME=GCLOUD-CONFIG

before_install:

install:
  - docker pull gcr.io/cloud-builders/docker
  - docker pull gcr.io/cloud-builders/gcloud
  - docker volume create config-gcloud

script:
  - docker build -t gcr.io/un-cloud-builders/gcloud-config:${COMMIT_TAG} .
  - docker run -it --rm
    --mount source=config-gcloud,target=/root/.config/gcloud
    -e GCLOUD_SERVICE_KEY=${GCLOUD_SERVICE_KEY}
    gcr.io/un-cloud-builders/gcloud-config:${COMMIT_TAG}

  - docker run -it --rm
    --mount source=config-gcloud,target=/root/.config/gcloud
    gcr.io/cloud-builders/gcloud auth list

after_script:
  - docker volume rm config-gcloud