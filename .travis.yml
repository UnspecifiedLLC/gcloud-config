sudo: false
language: generic

services:
  - docker

env:
  global:
    - BASENAME=GCLOUD-CONFIG
    - COMMIT_TAG=${TRAVIS_COMMIT::6}

before_install:

install:
  - docker pull gcr.io/cloud-builders/docker
  - docker volume create config-gcloud

script:
  - docker build -t gcr.io/un-cloud-builders/gcloud-config:${COMMIT_TAG} .
  - docker run -it --rm
    --mount source=config-gcloud,target=/root/.config/gcloud
    -e GCLOUD_SERVICE_KEY=${GCLOUD_SERVICE_KEY=}
    gcr.io/un-cloud-builders/gcloud-config:${COMMIT_TAG}
  - docker run -it --rm
    --mount source=config-gcloud,target=/root/.config/gcloud
    -v /var/run/docker.sock:/var/run/docker.sock
    gcr.io/cloud-builders/docker images
  - python build/publish.py

after_script:
  - docker volume rm config-gcloud